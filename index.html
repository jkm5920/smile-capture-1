<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>스마일 캡처 앱</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    body { text-align: center; background: #222; color: #fff; font-family: sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    video, canvas { border: 2px solid #0b84ff; border-radius: 10px; margin: 10px; background: #000; }
    button { margin: 15px 10px; padding: 12px 24px; border: none; border-radius: 8px; background: #0b84ff; color: white; font-size: 16px; cursor: pointer; }
    button:hover { background: #0066cc; }
    button:disabled { background: #666; cursor: not-allowed; }
    .status { margin: 10px 0; padding: 10px; border-radius: 5px; background: #333; }
    .success { background: #2d5a2d; }
    .error { background: #5a2d2d; }
    .warning { background: #5a552d; }
  </style>
</head>
<body>
  <div class="container">
    <h2>🎭 스마일 캡처 앱</h2>
    <p>웃으면 자동으로 감지되어 사진을 저장할 수 있어요!</p>
    
    <div id="status" class="status">로딩 중...</div>
    
    <div>
      <video id="video" width="400" height="300" autoplay muted playsinline></video>
      <canvas id="overlay" width="400" height="300"></canvas>
    </div>
    
    <div>
      <button id="startCamera">카메라 시작</button>
      <button id="capture" disabled>😊 사진 저장하기</button>
    </div>
    
    <div id="detectionInfo" style="margin-top: 20px;"></div>
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const context = overlay.getContext('2d');
    const statusDiv = document.getElementById('status');
    const detectionInfo = document.getElementById('detectionInfo');
    const captureBtn = document.getElementById('capture');
    const startCameraBtn = document.getElementById('startCamera');

    let isCameraActive = false;
    let detectionInterval;

    function updateStatus(message, type = '') {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    async function loadModels() {
      updateStatus('AI 모델 로드 중...', 'warning');
      try {
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/'),
          faceapi.nets.faceExpressionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/'),
          faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/')
        ]);
        updateStatus('AI 모델 로드 완료! 카메라를 시작해주세요.', 'success');
        startCameraBtn.disabled = false;
      } catch (error) {
        updateStatus('모델 로드 실패: ' + error.message, 'error');
      }
    }

    async function startCamera() {
      if (isCameraActive) return;
      
      updateStatus('카메라 접근 권한 요청 중...', 'warning');
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 400 },
            height: { ideal: 300 },
            facingMode: 'user'
          },
          audio: false 
        });
        
        video.srcObject = stream;
        isCameraActive = true;
        startCameraBtn.disabled = true;
        captureBtn.disabled = false;
        updateStatus('카메라 연결 성공! 얼굴을 인식 중...', 'success');
        startFaceDetection();
        
      } catch (error) {
        updateStatus('카메라 접근 실패: ' + error.message, 'error');
      }
    }

    function startFaceDetection() {
      const displaySize = { width: video.width, height: video.height };
      faceapi.matchDimensions(overlay, displaySize);
      
      detectionInterval = setInterval(async () => {
        if (video.paused || video.ended) return;
        
        try {
          const detections = await faceapi
            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceExpressions();
          
          context.clearRect(0, 0, overlay.width, overlay.height);
          const resizedDetections = faceapi.resizeResults(detections, displaySize);
          
          faceapi.draw.drawDetections(overlay, resizedDetections);
          faceapi.draw.drawFaceLandmarks(overlay, resizedDetections);
          faceapi.draw.drawFaceExpressions(overlay, resizedDetections);
          
          updateDetectionInfo(detections);
          
          if (detections.length > 0) {
            const expressions = detections[0].expressions;
            const smileConfidence = expressions.happy;
            
            if (smileConfidence > 0.8) {
              captureBtn.style.background = '#ff4444';
              captureBtn.innerHTML = '😄 웃는 얼굴 감지됨!';
            } else {
              captureBtn.style.background = '#0b84ff';
              captureBtn.innerHTML = '😊 사진 저장하기';
            }
          }
          
        } catch (error) {
          console.error('Face detection error:', error);
        }
      }, 300);
    }

    function updateDetectionInfo(detections) {
      if (detections.length === 0) {
        detectionInfo.innerHTML = '<p>얼굴이 감지되지 않았습니다. 카메라 앞으로 이동해주세요.</p>';
        return;
      }
      
      const expressions = detections[0].expressions;
      let infoHTML = '<h3>표정 분석 결과:</h3>';
      infoHTML += '<div style="display: flex; flex-wrap: wrap; justify-content: center;">';
      
      Object.entries(expressions).forEach(([emotion, confidence]) => {
        const percent = (confidence * 100).toFixed(1);
        const emoji = {
          'happy': '😄', 'sad': '😢', 'angry': '😠', 'fearful': '😨',
          'disgusted': '🤢', 'surprised': '😲', 'neutral': '😐'
        }[emotion] || '❓';
        
        infoHTML += `
          <div style="margin: 5px; padding: 8px; background: #333; border-radius: 5px; min-width: 100px;">
            <div>${emoji} ${emotion}</div>
            <div>${percent}%</div>
          </div>
        `;
      });
      
      infoHTML += '</div>';
      detectionInfo.innerHTML = infoHTML;
    }

    function capturePhoto() {
      if (!isCameraActive) {
        alert('먼저 카메라를 시작해주세요!');
        return;
      }
      
      try {
        const link = document.createElement('a');
        link.href = overlay.toDataURL('image/png');
        link.download = `smile_${new Date().getTime()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        updateStatus('사진이 저장되었습니다!', 'success');
      } catch (error) {
        updateStatus('사진 저장 실패: ' + error.message, 'error');
      }
    }

    startCameraBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', capturePhoto);
    window.addEventListener('load', loadModels);
    window.addEventListener('beforeunload', () => {
      if (detectionInterval) clearInterval(detectionInterval);
      if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
    });
  </script>
</body>
</html>
